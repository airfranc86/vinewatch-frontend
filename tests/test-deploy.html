<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Deploy - VineWatch</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 40px 20px;
            line-height: 1.6;
        }

        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success {
            color: #065F46;
        }

        .error {
            color: #7F1D1D;
        }

        .warning {
            color: #92400E;
        }

        .code {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        button {
            background: #8B5CF6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            background: #7C3AED;
        }

        button:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
        }

        #results {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>üß™ Test de Deploy - VineWatch</h1>
    <p>Esta p√°gina te ayuda a verificar que la configuraci√≥n est√© funcionando correctamente.</p>

    <div class="test-section">
        <h2>1. Variables de Entorno</h2>
        <button onclick="testEnvironmentVariables()">Verificar Variables</button>
        <div id="env-results"></div>
    </div>

    <div class="test-section">
        <h2>2. Configuraci√≥n de Supabase</h2>
        <button onclick="testSupabaseConfig()">Verificar Supabase</button>
        <div id="supabase-results"></div>
    </div>

    <div class="test-section">
        <h2>3. Test de Autenticaci√≥n</h2>
        <input type="email" id="test-email" placeholder="Ingresa tu email para probar"
            style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
        <button onclick="testAuthentication()">Probar Magic Link</button>
        <div id="auth-results"></div>
    </div>

    <div class="test-section">
        <h2>4. URLs de Redirecci√≥n</h2>
        <button onclick="testRedirectUrls()">Verificar URLs</button>
        <div id="redirect-results"></div>
    </div>

    <div id="results"></div>

    <script>
        // Configurar variables de entorno (igual que en index.html)
        window.VITE_SUPABASE_URL = window.VITE_SUPABASE_URL || 'https://agesojhoiemujyokbyin.supabase.co'
        window.VITE_SUPABASE_ANON_KEY = window.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnZXNvamhvaWVtdWp5b2tieWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4NTczMTEsImV4cCI6MjA3NDQzMzMxMX0.03CwWaoXbWJINCE7nzLV4dwSJhvlSu9kC8S-V5VCXJo'
        window.CURRENT_URL = window.location.origin

        function logResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId)
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : ''
            element.innerHTML += `<div class="${className}">${message}</div>`
        }

        function clearResults(elementId) {
            document.getElementById(elementId).innerHTML = ''
        }

        async function testEnvironmentVariables() {
            clearResults('env-results')

            logResult('env-results', 'üîç Verificando variables de entorno...')

            if (window.VITE_SUPABASE_URL) {
                logResult('env-results', `‚úÖ VITE_SUPABASE_URL: ${window.VITE_SUPABASE_URL}`, 'success')
            } else {
                logResult('env-results', '‚ùå VITE_SUPABASE_URL no est√° definida', 'error')
            }

            if (window.VITE_SUPABASE_ANON_KEY) {
                logResult('env-results', `‚úÖ VITE_SUPABASE_ANON_KEY: ${window.VITE_SUPABASE_ANON_KEY.substring(0, 20)}...`, 'success')
            } else {
                logResult('env-results', '‚ùå VITE_SUPABASE_ANON_KEY no est√° definida', 'error')
            }

            logResult('env-results', `üåê URL actual: ${window.CURRENT_URL}`)
        }

        async function testSupabaseConfig() {
            clearResults('supabase-results')

            logResult('supabase-results', 'üîç Verificando configuraci√≥n de Supabase...')

            try {
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2')

                const supabase = createClient(
                    window.VITE_SUPABASE_URL,
                    window.VITE_SUPABASE_ANON_KEY,
                    {
                        auth: {
                            redirectTo: window.CURRENT_URL + '/auth/callback.html'
                        }
                    }
                )

                logResult('supabase-results', '‚úÖ Cliente de Supabase creado correctamente', 'success')
                logResult('supabase-results', `üîó URL de redirecci√≥n: ${window.CURRENT_URL}/auth/callback.html`)

            } catch (error) {
                logResult('supabase-results', `‚ùå Error al crear cliente de Supabase: ${error.message}`, 'error')
            }
        }

        async function testAuthentication() {
            clearResults('auth-results')

            const email = document.getElementById('test-email').value.trim()

            if (!email) {
                logResult('auth-results', '‚ö†Ô∏è Por favor, ingresa un email', 'warning')
                return
            }

            logResult('auth-results', `üìß Probando autenticaci√≥n con: ${email}`)

            try {
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2')

                const supabase = createClient(
                    window.VITE_SUPABASE_URL,
                    window.VITE_SUPABASE_ANON_KEY,
                    {
                        auth: {
                            redirectTo: window.CURRENT_URL + '/auth/callback.html'
                        }
                    }
                )

                logResult('auth-results', 'üîÑ Enviando Magic Link...')

                const { error } = await supabase.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: window.CURRENT_URL + '/auth/callback.html'
                    }
                })

                if (error) {
                    logResult('auth-results', `‚ùå Error: ${error.message}`, 'error')
                } else {
                    logResult('auth-results', '‚úÖ Magic Link enviado exitosamente! Revisa tu email.', 'success')
                }

            } catch (error) {
                logResult('auth-results', `‚ùå Error inesperado: ${error.message}`, 'error')
            }
        }

        function testRedirectUrls() {
            clearResults('redirect-results')

            logResult('redirect-results', 'üîç Verificando URLs de redirecci√≥n...')

            const currentUrl = window.location.origin
            const callbackUrl = currentUrl + '/auth/callback.html'

            logResult('redirect-results', `üåê URL actual: ${currentUrl}`)
            logResult('redirect-results', `üîó URL de callback: ${callbackUrl}`)

            // Verificar si el archivo de callback existe
            fetch('/auth/callback.html')
                .then(response => {
                    if (response.ok) {
                        logResult('redirect-results', '‚úÖ Archivo callback.html encontrado', 'success')
                    } else {
                        logResult('redirect-results', '‚ùå Archivo callback.html no encontrado', 'error')
                    }
                })
                .catch(error => {
                    logResult('redirect-results', `‚ùå Error al verificar callback.html: ${error.message}`, 'error')
                })

            logResult('redirect-results', 'üìù Aseg√∫rate de configurar esta URL en Supabase:')
            logResult('redirect-results', `<code>${callbackUrl}</code>`)
        }

        // Ejecutar tests autom√°ticamente al cargar
        window.addEventListener('load', function () {
            testEnvironmentVariables()
            testSupabaseConfig()
            testRedirectUrls()
        })
    </script>
</body>

</html>