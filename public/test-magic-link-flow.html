<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Magic Link Flow - VineWatch</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #8B5CF6;
        }
        .success { color: #10B981; }
        .error { color: #EF4444; }
        .warning { color: #F59E0B; }
        .info { color: #3B82F6; }
        button {
            background: #8B5CF6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 600;
        }
        button:hover { background: #7C3AED; }
        .code {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            margin: 10px 0;
            border: 1px solid #444;
            word-break: break-all;
        }
        .step {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #8B5CF6;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Magic Link Flow - VineWatch</h1>
    <p>Esta p√°gina simula el flujo completo del Magic Link para identificar d√≥nde falla.</p>

    <div class="test-section">
        <h2>üìß Paso 1: Enviar Magic Link</h2>
        <input type="email" id="test-email" placeholder="franciscoaucar@gmail.com" 
               style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #444; border-radius: 4px; background: #333; color: white;">
        <button onclick="sendMagicLink()">Enviar Magic Link</button>
        <div id="step1-results"></div>
    </div>

    <div class="test-section">
        <h2>üîó Paso 2: Simular Click en Magic Link</h2>
        <button onclick="simulateMagicLinkClick()">Simular Click en Magic Link</button>
        <div id="step2-results"></div>
    </div>

    <div class="test-section">
        <h2>üîÑ Paso 3: Procesar Callback</h2>
        <button onclick="processCallback()">Procesar Callback</button>
        <div id="step3-results"></div>
    </div>

    <div class="test-section">
        <h2>üìä An√°lisis Completo</h2>
        <button onclick="runFullAnalysis()">Ejecutar An√°lisis Completo</button>
        <div id="analysis-results"></div>
    </div>

    <script src="config.js"></script>
    <script>
        let magicLinkData = null;

        async function sendMagicLink() {
            const email = document.getElementById('test-email').value.trim();
            const results = document.getElementById('step1-results');
            
            if (!email) {
                results.innerHTML = '<div class="warning">‚ö†Ô∏è Por favor, ingresa un email</div>';
                return;
            }
            
            results.innerHTML = '<div class="info">üìß Enviando Magic Link...</div>';
            
            try {
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
                
                const supabase = createClient(
                    window.VITE_SUPABASE_URL,
                    window.VITE_SUPABASE_ANON_KEY,
                    {
                        auth: {
                            redirectTo: window.CURRENT_URL + '/auth/callback.html'
                        }
                    }
                );
                
                const startTime = new Date();
                const { error } = await supabase.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: window.CURRENT_URL + '/auth/callback.html'
                    }
                });
                
                const endTime = new Date();
                
                if (error) {
                    results.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                } else {
                    results.innerHTML = `
                        <div class="success">‚úÖ Magic Link enviado exitosamente</div>
                        <div class="info">‚è±Ô∏è Tiempo: ${endTime - startTime}ms</div>
                        <div class="info">üïê Enviado: ${endTime.toLocaleString()}</div>
                        <div class="info">üìß Email: ${email}</div>
                        <div class="info">üîó Redirecci√≥n: ${window.CURRENT_URL}/auth/callback.html</div>
                    `;
                    
                    magicLinkData = {
                        email: email,
                        sentAt: endTime,
                        redirectUrl: window.CURRENT_URL + '/auth/callback.html'
                    };
                }
                
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Error inesperado: ${error.message}</div>`;
            }
        }

        function simulateMagicLinkClick() {
            const results = document.getElementById('step2-results');
            results.innerHTML = '<div class="info">üîó Simulando click en Magic Link...</div>';
            
            // Simular diferentes escenarios de URL que podr√≠an llegar al callback
            const scenarios = [
                {
                    name: 'Escenario 1: Magic Link v√°lido',
                    url: `${window.CURRENT_URL}/auth/callback.html?access_token=test_token_123&refresh_token=test_refresh_123&expires_in=3600&token_type=bearer`,
                    description: 'URL con tokens v√°lidos'
                },
                {
                    name: 'Escenario 2: Magic Link expirado',
                    url: `${window.CURRENT_URL}/auth/callback.html#error=access_denied&error_code=otp_expired&error_description=Email+link+is+invalid+or+has+expired`,
                    description: 'URL con error de expiraci√≥n (tu caso actual)'
                },
                {
                    name: 'Escenario 3: Error de acceso',
                    url: `${window.CURRENT_URL}/auth/callback.html#error=access_denied&error_description=Access+denied`,
                    description: 'URL con error de acceso denegado'
                }
            ];
            
            let html = '<div class="info">üìã Escenarios de prueba:</div>';
            scenarios.forEach((scenario, index) => {
                html += `
                    <div class="step">
                        <strong>${scenario.name}</strong><br>
                        <span class="info">${scenario.description}</span><br>
                        <div class="code">${scenario.url}</div>
                        <button onclick="testScenario(${index})">Probar este escenario</button>
                    </div>
                `;
            });
            
            results.innerHTML = html;
        }

        function testScenario(index) {
            const scenarios = [
                {
                    url: `${window.CURRENT_URL}/auth/callback.html?access_token=test_token_123&refresh_token=test_refresh_123&expires_in=3600&token_type=bearer`
                },
                {
                    url: `${window.CURRENT_URL}/auth/callback.html#error=access_denied&error_code=otp_expired&error_description=Email+link+is+invalid+or+has+expired`
                },
                {
                    url: `${window.CURRENT_URL}/auth/callback.html#error=access_denied&error_description=Access+denied`
                }
            ];
            
            const scenario = scenarios[index];
            
            // Simular navegaci√≥n a la URL del callback
            const results = document.getElementById('step3-results');
            results.innerHTML = '<div class="info">üîÑ Procesando callback...</div>';
            
            // Simular el procesamiento del callback
            setTimeout(() => {
                processCallbackUrl(scenario.url);
            }, 1000);
        }

        function processCallbackUrl(url) {
            const results = document.getElementById('step3-results');
            
            try {
                const urlObj = new URL(url);
                const urlParams = new URLSearchParams(urlObj.search);
                const hashParams = new URLSearchParams(urlObj.hash.substring(1));
                
                // Combinar par√°metros
                const allParams = new URLSearchParams();
                for (const [key, value] of urlParams.entries()) {
                    allParams.set(key, value);
                }
                for (const [key, value] of hashParams.entries()) {
                    allParams.set(key, value);
                }
                
                const accessToken = allParams.get('access_token');
                const refreshToken = allParams.get('refresh_token');
                const error = allParams.get('error');
                const errorCode = allParams.get('error_code');
                const errorDescription = allParams.get('error_description');
                
                let resultHtml = '<div class="info">üîç An√°lisis del callback:</div>';
                resultHtml += `<div class="code">URL: ${url}</div>`;
                
                if (error) {
                    resultHtml += `
                        <div class="error">
                            <strong>‚ùå Error detectado:</strong><br>
                            Error: ${error}<br>
                            C√≥digo: ${errorCode}<br>
                            Descripci√≥n: ${errorDescription}
                        </div>
                    `;
                    
                    if (errorCode === 'otp_expired') {
                        resultHtml += `
                            <div class="warning">
                                <strong>‚ö†Ô∏è Diagn√≥stico:</strong><br>
                                El Magic Link ha expirado. Posibles causas:<br>
                                1. Tiempo de expiraci√≥n muy corto en Supabase<br>
                                2. Magic Link usado m√∫ltiples veces<br>
                                3. Problema de sincronizaci√≥n de tiempo<br>
                                4. Configuraci√≥n incorrecta de Supabase
                            </div>
                        `;
                    }
                } else if (accessToken && refreshToken) {
                    resultHtml += `
                        <div class="success">
                            <strong>‚úÖ Tokens v√°lidos detectados:</strong><br>
                            Access Token: ${accessToken.substring(0, 20)}...<br>
                            Refresh Token: ${refreshToken.substring(0, 20)}...<br>
                            <strong>El callback deber√≠a funcionar correctamente.</strong>
                        </div>
                    `;
                } else {
                    resultHtml += `
                        <div class="warning">
                            <strong>‚ö†Ô∏è No se detectaron tokens ni errores</strong><br>
                            La URL no contiene informaci√≥n de autenticaci√≥n v√°lida.
                        </div>
                    `;
                }
                
                results.innerHTML = resultHtml;
                
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Error procesando URL: ${error.message}</div>`;
            }
        }

        function processCallback() {
            const results = document.getElementById('step3-results');
            results.innerHTML = '<div class="info">üîÑ Procesando callback actual...</div>';
            
            // Usar la URL actual
            processCallbackUrl(window.location.href);
        }

        async function runFullAnalysis() {
            const results = document.getElementById('analysis-results');
            results.innerHTML = '<div class="info">üîç Ejecutando an√°lisis completo...</div>';
            
            let analysis = '<div class="info"><strong>üìä An√°lisis Completo del Flujo Magic Link</strong></div>';
            
            // 1. Verificar configuraci√≥n
            analysis += '<div class="step"><strong>1. Configuraci√≥n:</strong><br>';
            analysis += `URL Supabase: ${window.VITE_SUPABASE_URL}<br>`;
            analysis += `Clave: ${window.VITE_SUPABASE_ANON_KEY ? 'Configurada' : 'No configurada'}<br>`;
            analysis += `Redirecci√≥n: ${window.CURRENT_URL}/auth/callback.html</div>`;
            
            // 2. Verificar tiempo actual
            const now = new Date();
            analysis += `<div class="step"><strong>2. Tiempo actual:</strong><br>${now.toLocaleString()}</div>`;
            
            // 3. Verificar si hay un Magic Link pendiente
            if (magicLinkData) {
                const timeSinceSent = now - magicLinkData.sentAt;
                analysis += `<div class="step"><strong>3. Magic Link enviado:</strong><br>`;
                analysis += `Email: ${magicLinkData.email}<br>`;
                analysis += `Enviado: ${magicLinkData.sentAt.toLocaleString()}<br>`;
                analysis += `Hace: ${Math.round(timeSinceSent / 1000 / 60)} minutos</div>`;
            }
            
            // 4. Recomendaciones
            analysis += `<div class="step"><strong>4. Recomendaciones:</strong><br>`;
            analysis += `‚Ä¢ Verificar configuraci√≥n de Supabase Dashboard<br>`;
            analysis += `‚Ä¢ Revisar tiempo de expiraci√≥n en Email Templates<br>`;
            analysis += `‚Ä¢ Verificar que la URL de redirecci√≥n est√© correcta<br>`;
            analysis += `‚Ä¢ Probar con un email diferente<br>`;
            analysis += `‚Ä¢ Revisar logs de Supabase para errores</div>`;
            
            results.innerHTML = analysis;
        }

        // Ejecutar an√°lisis autom√°tico al cargar
        window.addEventListener('load', function() {
            console.log('üß™ P√°gina de test Magic Link Flow cargada');
        });
    </script>
</body>
</html>
