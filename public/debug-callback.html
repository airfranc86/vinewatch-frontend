<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Callback - VineWatch</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .debug-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #8B5CF6;
        }
        .success { color: #10B981; }
        .error { color: #EF4444; }
        .warning { color: #F59E0B; }
        .info { color: #3B82F6; }
        .code {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            margin: 10px 0;
            border: 1px solid #444;
            word-break: break-all;
            white-space: pre-wrap;
        }
        button {
            background: #8B5CF6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 600;
        }
        button:hover { background: #7C3AED; }
    </style>
</head>
<body>
    <h1>üîß Debug Callback - VineWatch</h1>
    <p>Esta p√°gina te ayuda a diagnosticar problemas en el callback del Magic Link.</p>

    <div class="debug-section">
        <h2>üîç An√°lisis de URL Actual</h2>
        <button onclick="analyzeCurrentUrl()">Analizar URL Actual</button>
        <div id="url-analysis"></div>
    </div>

    <div class="debug-section">
        <h2>üß™ Simular Magic Link</h2>
        <button onclick="simulateMagicLink()">Simular Magic Link V√°lido</button>
        <button onclick="simulateExpiredLink()">Simular Magic Link Expirado</button>
        <div id="simulation-results"></div>
    </div>

    <div class="debug-section">
        <h2>üîß Test de Supabase</h2>
        <button onclick="testSupabaseConnection()">Probar Conexi√≥n Supabase</button>
        <div id="supabase-test"></div>
    </div>

    <div class="debug-section">
        <h2>üìä Logs en Tiempo Real</h2>
        <button onclick="enableLogging()">Habilitar Logs</button>
        <div id="logs"></div>
    </div>

    <script src="config.js"></script>
    <script>
        function analyzeCurrentUrl() {
            const results = document.getElementById('url-analysis');
            
            const url = window.location.href;
            const urlObj = new URL(url);
            
            let html = '<div class="info"><strong>üîç An√°lisis de URL Actual:</strong></div>';
            html += `<div class="code">URL completa: ${url}</div>`;
            html += `<div class="code">Protocolo: ${urlObj.protocol}</div>`;
            html += `<div class="code">Host: ${urlObj.host}</div>`;
            html += `<div class="code">Pathname: ${urlObj.pathname}</div>`;
            html += `<div class="code">Search: ${urlObj.search}</div>`;
            html += `<div class="code">Hash: ${urlObj.hash}</div>`;
            
            // Analizar par√°metros
            const urlParams = new URLSearchParams(urlObj.search);
            const hashParams = new URLSearchParams(urlObj.hash.substring(1));
            
            html += '<div class="info"><strong>üìã Par√°metros detectados:</strong></div>';
            
            if (urlParams.size > 0) {
                html += '<div class="info">Query Parameters:</div>';
                for (const [key, value] of urlParams.entries()) {
                    html += `<div class="code">${key}: ${value}</div>`;
                }
            }
            
            if (hashParams.size > 0) {
                html += '<div class="info">Hash Parameters:</div>';
                for (const [key, value] of hashParams.entries()) {
                    html += `<div class="code">${key}: ${value}</div>`;
                }
            }
            
            if (urlParams.size === 0 && hashParams.size === 0) {
                html += '<div class="warning">‚ö†Ô∏è No se detectaron par√°metros en la URL</div>';
            }
            
            // Verificar si es un Magic Link v√°lido
            const accessToken = urlParams.get('access_token') || hashParams.get('access_token');
            const refreshToken = urlParams.get('refresh_token') || hashParams.get('refresh_token');
            const error = urlParams.get('error') || hashParams.get('error');
            
            if (accessToken && refreshToken) {
                html += '<div class="success">‚úÖ Magic Link v√°lido detectado</div>';
            } else if (error) {
                html += `<div class="error">‚ùå Error detectado: ${error}</div>`;
            } else {
                html += '<div class="warning">‚ö†Ô∏è No se detect√≥ Magic Link v√°lido ni error</div>';
            }
            
            results.innerHTML = html;
        }

        function simulateMagicLink() {
            const results = document.getElementById('simulation-results');
            
            // Simular URL con Magic Link v√°lido
            const mockUrl = `${window.location.origin}${window.location.pathname}?access_token=mock_access_token_123&refresh_token=mock_refresh_token_456&expires_in=3600&token_type=bearer`;
            
            let html = '<div class="info"><strong>üß™ Simulando Magic Link V√°lido:</strong></div>';
            html += `<div class="code">URL simulada: ${mockUrl}</div>`;
            
            // Simular procesamiento
            try {
                const urlObj = new URL(mockUrl);
                const urlParams = new URLSearchParams(urlObj.search);
                
                const accessToken = urlParams.get('access_token');
                const refreshToken = urlParams.get('refresh_token');
                
                if (accessToken && refreshToken) {
                    html += '<div class="success">‚úÖ Tokens detectados correctamente</div>';
                    html += '<div class="success">‚úÖ El callback deber√≠a funcionar</div>';
                } else {
                    html += '<div class="error">‚ùå Error en la simulaci√≥n</div>';
                }
            } catch (error) {
                html += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
            
            results.innerHTML = html;
        }

        function simulateExpiredLink() {
            const results = document.getElementById('simulation-results');
            
            // Simular URL con Magic Link expirado
            const mockUrl = `${window.location.origin}${window.location.pathname}#error=access_denied&error_code=otp_expired&error_description=Email+link+is+invalid+or+has+expired`;
            
            let html = '<div class="info"><strong>üß™ Simulando Magic Link Expirado:</strong></div>';
            html += `<div class="code">URL simulada: ${mockUrl}</div>`;
            
            // Simular procesamiento
            try {
                const urlObj = new URL(mockUrl);
                const hashParams = new URLSearchParams(urlObj.hash.substring(1));
                
                const error = hashParams.get('error');
                const errorCode = hashParams.get('error_code');
                const errorDescription = hashParams.get('error_description');
                
                if (error === 'access_denied' && errorCode === 'otp_expired') {
                    html += '<div class="error">‚ùå Error de expiraci√≥n detectado correctamente</div>';
                    html += '<div class="warning">‚ö†Ô∏è Este es el comportamiento esperado para un Magic Link expirado</div>';
                } else {
                    html += '<div class="error">‚ùå Error en la simulaci√≥n</div>';
                }
            } catch (error) {
                html += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
            
            results.innerHTML = html;
        }

        async function testSupabaseConnection() {
            const results = document.getElementById('supabase-test');
            
            results.innerHTML = '<div class="info">üîß Probando conexi√≥n con Supabase...</div>';
            
            try {
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
                
                const supabaseUrl = window.VITE_SUPABASE_URL;
                const supabaseKey = window.VITE_SUPABASE_ANON_KEY;
                
                if (!supabaseUrl || !supabaseKey) {
                    results.innerHTML = '<div class="error">‚ùå Variables de entorno no configuradas</div>';
                    return;
                }
                
                const supabase = createClient(supabaseUrl, supabaseKey);
                
                // Test de conexi√≥n
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    results.innerHTML = `<div class="error">‚ùå Error de conexi√≥n: ${error.message}</div>`;
                } else {
                    results.innerHTML = '<div class="success">‚úÖ Conexi√≥n con Supabase exitosa</div>';
                }
                
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Error inesperado: ${error.message}</div>`;
            }
        }

        function enableLogging() {
            const results = document.getElementById('logs');
            
            // Interceptar console.log
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            
            let logMessages = [];
            
            console.log = function(...args) {
                logMessages.push(`[LOG] ${args.join(' ')}`);
                originalLog.apply(console, args);
                updateLogDisplay();
            };
            
            console.error = function(...args) {
                logMessages.push(`[ERROR] ${args.join(' ')}`);
                originalError.apply(console, args);
                updateLogDisplay();
            };
            
            console.warn = function(...args) {
                logMessages.push(`[WARN] ${args.join(' ')}`);
                originalWarn.apply(console, args);
                updateLogDisplay();
            };
            
            function updateLogDisplay() {
                const logHtml = logMessages.slice(-20).map(msg => 
                    `<div class="code">${msg}</div>`
                ).join('');
                results.innerHTML = `<div class="info"><strong>üìä Logs en Tiempo Real:</strong></div>${logHtml}`;
            }
            
            results.innerHTML = '<div class="success">‚úÖ Logging habilitado. Los logs aparecer√°n aqu√≠.</div>';
        }

        // Ejecutar an√°lisis autom√°tico al cargar
        window.addEventListener('load', function() {
            console.log('üîß P√°gina de debug callback cargada');
            analyzeCurrentUrl();
        });
    </script>
</body>
</html>
