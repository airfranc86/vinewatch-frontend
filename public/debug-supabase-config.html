<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Supabase Config - VineWatch</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .debug-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #8B5CF6;
        }
        .success { color: #10B981; }
        .error { color: #EF4444; }
        .warning { color: #F59E0B; }
        .info { color: #3B82F6; }
        button {
            background: #8B5CF6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 600;
        }
        button:hover { background: #7C3AED; }
        .code {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            margin: 10px 0;
            border: 1px solid #444;
            word-break: break-all;
            white-space: pre-wrap;
        }
        .step {
            background: #333;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #8B5CF6;
        }
        .test-result {
            background: #444;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #8B5CF6;
        }
    </style>
</head>
<body>
    <h1>üîß Debug Supabase Config - VineWatch</h1>
    <p>Esta p√°gina te ayuda a diagnosticar problemas de configuraci√≥n de Supabase.</p>

    <div class="debug-section">
        <h2>üìã Verificaci√≥n de Configuraci√≥n</h2>
        <button onclick="checkSupabaseConfig()">Verificar Configuraci√≥n</button>
        <div id="config-results"></div>
    </div>

    <div class="debug-section">
        <h2>üß™ Test de Magic Link</h2>
        <input type="email" id="test-email" placeholder="franciscoaucar@gmail.com" 
               style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #444; border-radius: 4px; background: #333; color: white;">
        <button onclick="testMagicLink()">Test Magic Link</button>
        <div id="magic-link-results"></div>
    </div>

    <div class="debug-section">
        <h2>‚è∞ Test de Tiempo</h2>
        <button onclick="testTimeSync()">Verificar Sincronizaci√≥n de Tiempo</button>
        <div id="time-results"></div>
    </div>

    <div class="debug-section">
        <h2>üîç An√°lisis de URL</h2>
        <button onclick="analyzeCurrentUrl()">Analizar URL Actual</button>
        <div id="url-results"></div>
    </div>

    <div class="debug-section">
        <h2>üìä Logs Detallados</h2>
        <button onclick="enableDetailedLogging()">Habilitar Logs Detallados</button>
        <div id="logs-results"></div>
    </div>

    <script src="config.js"></script>
    <script>
        let supabaseClient = null;

        async function checkSupabaseConfig() {
            const results = document.getElementById('config-results');
            results.innerHTML = '<div class="info">üîç Verificando configuraci√≥n...</div>';
            
            try {
                const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
                
                // Verificar variables de entorno
                const supabaseUrl = window.VITE_SUPABASE_URL;
                const supabaseKey = window.VITE_SUPABASE_ANON_KEY;
                
                let configHtml = '<div class="info"><strong>üìã Configuraci√≥n Actual:</strong></div>';
                configHtml += `<div class="code">URL: ${supabaseUrl}</div>`;
                configHtml += `<div class="code">Key: ${supabaseKey ? supabaseKey.substring(0, 20) + '...' : 'No configurada'}</div>`;
                configHtml += `<div class="code">Current URL: ${window.CURRENT_URL}</div>`;
                
                if (!supabaseUrl || !supabaseKey) {
                    configHtml += '<div class="error">‚ùå Variables de entorno no configuradas</div>';
                    results.innerHTML = configHtml;
                    return;
                }
                
                // Crear cliente
                supabaseClient = createClient(supabaseUrl, supabaseKey, {
                    auth: {
                        redirectTo: window.CURRENT_URL + '/auth/callback.html'
                    }
                });
                
                // Test de conexi√≥n
                const { data, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    configHtml += `<div class="error">‚ùå Error de conexi√≥n: ${error.message}</div>`;
                } else {
                    configHtml += '<div class="success">‚úÖ Conexi√≥n con Supabase exitosa</div>';
                }
                
                // Verificar configuraci√≥n de auth
                const authConfig = supabaseClient.auth.getConfig();
                configHtml += `<div class="code">Auth Config: ${JSON.stringify(authConfig, null, 2)}</div>`;
                
                results.innerHTML = configHtml;
                
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Error inesperado: ${error.message}</div>`;
            }
        }

        async function testMagicLink() {
            const email = document.getElementById('test-email').value.trim();
            const results = document.getElementById('magic-link-results');
            
            if (!email) {
                results.innerHTML = '<div class="warning">‚ö†Ô∏è Por favor, ingresa un email</div>';
                return;
            }
            
            results.innerHTML = '<div class="info">üìß Enviando Magic Link de prueba...</div>';
            
            try {
                if (!supabaseClient) {
                    const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
                    supabaseClient = createClient(
                        window.VITE_SUPABASE_URL,
                        window.VITE_SUPABASE_ANON_KEY,
                        {
                            auth: {
                                redirectTo: window.CURRENT_URL + '/auth/callback.html'
                            }
                        }
                    );
                }
                
                const startTime = new Date();
                const { data, error } = await supabaseClient.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: window.CURRENT_URL + '/auth/callback.html'
                    }
                });
                const endTime = new Date();
                
                let resultHtml = '<div class="info"><strong>üìß Resultado del Magic Link:</strong></div>';
                resultHtml += `<div class="code">Tiempo de env√≠o: ${endTime - startTime}ms</div>`;
                resultHtml += `<div class="code">Email: ${email}</div>`;
                resultHtml += `<div class="code">Redirect URL: ${window.CURRENT_URL}/auth/callback.html</div>`;
                
                if (error) {
                    resultHtml += `<div class="error">‚ùå Error: ${error.message}</div>`;
                    resultHtml += `<div class="code">Error Code: ${error.code || 'N/A'}</div>`;
                    resultHtml += `<div class="code">Error Details: ${JSON.stringify(error, null, 2)}</div>`;
                } else {
                    resultHtml += '<div class="success">‚úÖ Magic Link enviado exitosamente</div>';
                    resultHtml += `<div class="code">Data: ${JSON.stringify(data, null, 2)}</div>`;
                }
                
                results.innerHTML = resultHtml;
                
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Error inesperado: ${error.message}</div>`;
            }
        }

        function testTimeSync() {
            const results = document.getElementById('time-results');
            
            const now = new Date();
            const utcTime = now.toUTCString();
            const localTime = now.toLocaleString();
            const timestamp = now.getTime();
            
            let timeHtml = '<div class="info"><strong>‚è∞ Informaci√≥n de Tiempo:</strong></div>';
            timeHtml += `<div class="code">Tiempo local: ${localTime}</div>`;
            timeHtml += `<div class="code">Tiempo UTC: ${utcTime}</div>`;
            timeHtml += `<div class="code">Timestamp: ${timestamp}</div>`;
            timeHtml += `<div class="code">Timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}</div>`;
            
            // Verificar si hay problemas de tiempo
            const timezoneOffset = now.getTimezoneOffset();
            if (Math.abs(timezoneOffset) > 60) {
                timeHtml += '<div class="warning">‚ö†Ô∏è Posible problema de zona horaria</div>';
            }
            
            results.innerHTML = timeHtml;
        }

        function analyzeCurrentUrl() {
            const results = document.getElementById('url-results');
            
            const url = window.location.href;
            const urlObj = new URL(url);
            
            let urlHtml = '<div class="info"><strong>üîç An√°lisis de URL Actual:</strong></div>';
            urlHtml += `<div class="code">URL completa: ${url}</div>`;
            urlHtml += `<div class="code">Protocolo: ${urlObj.protocol}</div>`;
            urlHtml += `<div class="code">Host: ${urlObj.host}</div>`;
            urlHtml += `<div class="code">Pathname: ${urlObj.pathname}</div>`;
            urlHtml += `<div class="code">Search: ${urlObj.search}</div>`;
            urlHtml += `<div class="code">Hash: ${urlObj.hash}</div>`;
            
            // Analizar par√°metros
            const urlParams = new URLSearchParams(urlObj.search);
            const hashParams = new URLSearchParams(urlObj.hash.substring(1));
            
            if (urlParams.size > 0 || hashParams.size > 0) {
                urlHtml += '<div class="info"><strong>üìã Par√°metros detectados:</strong></div>';
                
                for (const [key, value] of urlParams.entries()) {
                    urlHtml += `<div class="code">Query ${key}: ${value}</div>`;
                }
                
                for (const [key, value] of hashParams.entries()) {
                    urlHtml += `<div class="code">Hash ${key}: ${value}</div>`;
                }
            }
            
            results.innerHTML = urlHtml;
        }

        function enableDetailedLogging() {
            const results = document.getElementById('logs-results');
            
            // Habilitar logging detallado
            console.log('üîß Habilitando logging detallado...');
            
            // Interceptar console.log para mostrar en la p√°gina
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            
            let logMessages = [];
            
            console.log = function(...args) {
                logMessages.push(`[LOG] ${args.join(' ')}`);
                originalLog.apply(console, args);
                updateLogDisplay();
            };
            
            console.error = function(...args) {
                logMessages.push(`[ERROR] ${args.join(' ')}`);
                originalError.apply(console, args);
                updateLogDisplay();
            };
            
            console.warn = function(...args) {
                logMessages.push(`[WARN] ${args.join(' ')}`);
                originalWarn.apply(console, args);
                updateLogDisplay();
            };
            
            function updateLogDisplay() {
                const logHtml = logMessages.slice(-20).map(msg => 
                    `<div class="code">${msg}</div>`
                ).join('');
                results.innerHTML = `<div class="info"><strong>üìä Logs Detallados:</strong></div>${logHtml}`;
            }
            
            results.innerHTML = '<div class="success">‚úÖ Logging detallado habilitado. Los logs aparecer√°n aqu√≠.</div>';
        }

        // Ejecutar verificaci√≥n autom√°tica al cargar
        window.addEventListener('load', function() {
            console.log('üîß P√°gina de debug Supabase cargada');
            checkSupabaseConfig();
        });
    </script>
</body>
</html>
